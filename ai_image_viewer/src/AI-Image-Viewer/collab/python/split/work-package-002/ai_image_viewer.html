<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .header-title h1 {
            font-size: 28px;
            color: #333;
        }

        .ai-badge {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        button, select {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        button:hover, select:hover {
            background: #f0f0f0;
            transform: translateY(-1px);
        }

        .primary-btn {
            background: #667eea;
            color: white;
            border: none;
        }

        .primary-btn:hover {
            background: #5a67d8;
        }

        .ai-btn {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            border: none;
            position: relative;
            overflow: hidden;
        }

        .ai-btn:hover {
            background: linear-gradient(45deg, #ff5252, #26a69a);
        }

        .ai-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status {
            margin-left: auto;
            color: #666;
            font-weight: 500;
        }

        .ai-status {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            display: none;
        }

        .ai-status.active {
            display: block;
        }

        .ai-status h3 {
            color: #1976d2;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-progress {
            background: #e0e0e0;
            border-radius: 10px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }

        .ai-progress-bar {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .gallery {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }

        .image-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
        }

        .image-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .image-card.ai-analyzed::before {
            content: "üß† AI";
            position: absolute;
            top: 8px;
            right: 8px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            z-index: 2;
        }

        .image-container {
            position: relative;
            width: 100%;
            padding-top: 66.67%;
            background: #f7f7f7;
            overflow: hidden;
        }

        .image-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
        }

        .image-info {
            padding: 15px;
        }

        .ai-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 8px;
        }

        .ai-tag {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
        }

        .ai-description {
            font-size: 13px;
            color: #666;
            font-style: italic;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .image-caption {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
            padding: 4px;
            border: 1px solid transparent;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .search-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            justify-content: center;
            align-items: flex-start;
            padding-top: 50px;
        }

        .search-modal.active {
            display: flex;
        }

        .search-box {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .search-input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .search-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }

        .search-suggestion {
            background: #f0f0f0;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-suggestion:hover {
            background: #667eea;
            color: white;
        }

        .search-results {
            max-height: 400px;
            overflow-y: auto;
        }

        .search-result-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
            border: 1px solid transparent;
        }

        .search-result-item:hover {
            background: #f0f4ff;
            border-color: #667eea;
        }

        .search-result-thumb {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 15px;
        }

        .search-result-info {
            flex: 1;
        }

        .search-result-score {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 10px;
        }

        .drop-zone {
            position: relative;
            min-height: 200px;
            border: 2px dashed #ccc;
            border-radius: 12px;
            background: #fafafa;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .drop-zone.dragover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(102, 126, 234, 0); }
            100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0); }
        }

        .hidden {
            display: none !important;
        }

        /* Footer styles */
        .footer-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
            font-size: 14px;
        }

        .footer-info h3 {
            color: #1976d2;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            color: #1565c0;
        }

        @media (max-width: 768px) {
            .gallery {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .status {
                margin-left: 0;
                margin-top: 10px;
            }

            .feature-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-title">
                <span style="font-size: 32px;">üß†</span>
                <h1>AI Image Viewer</h1>
            </div>
            
            <div class="controls">
                <button class="primary-btn" id="selectFiles">üìÅ Select Images</button>
                <input type="file" id="filesInput" multiple style="display: none;" accept="image/*">
                <button class="primary-btn" id="selectFolder">üìÇ Select Folder</button>
                <input type="file" id="folderInput" webkitdirectory directory multiple style="display: none;" accept="image/*">
                
                <button class="ai-btn" id="analyzeBtn">üß† AI Analyze</button>
                <button class="ai-btn" id="searchBtn">üîç AI Search</button>
                <button class="primary-btn" id="autoTagBtn">üè∑Ô∏è Auto Tag</button>
                <button class="primary-btn" id="exportBtn">üíæ Export Metadata</button>
                <button class="primary-btn" id="importBtn">üìÇ Import Metadata</button>
                <input type="file" id="importFileInput" style="display: none;" accept=".json">
                
                <label for="gridLayout">Grid:</label>
                <select id="gridLayout">
                    <option value="2">2 per row</option>
                    <option value="3" selected>3 per row</option>
                    <option value="4">4 per row</option>
                    <option value="5">5 per row</option>
                </select>
                
                <span class="status" id="imageCount">0 images loaded</span>
            </div>
        </div>

        <div class="ai-status" id="aiStatus">
            <h3>üß† AI Processing</h3>
            <div id="aiStatusText">Initializing computer vision models...</div>
            <div class="ai-progress">
                <div class="ai-progress-bar" id="aiProgressBar">0%</div>
            </div>
        </div>

        <div class="drop-zone" id="dropZone">
            <div style="text-align: center; color: #666;">
                <div style="font-size: 48px; margin-bottom: 16px;">üß†üì∏</div>
                <div style="font-size: 18px; margin-bottom: 8px;">Drop images for AI-powered analysis</div>
                <div style="font-size: 14px;">Automatic object detection, scene understanding, and semantic search</div>
            </div>
        </div>

        <div class="gallery" id="gallery"></div>

        <!-- Footer with AI capabilities info -->
        <div class="footer-info">
            <h3>ü§ñ AI Computer Vision Features</h3>
            <div class="feature-grid">
                <div><strong>Object Detection:</strong> Identifies people, animals, objects in images</div>
                <div><strong>Scene Understanding:</strong> Recognizes locations, activities, emotions</div>
                <div><strong>Smart Search:</strong> Find images by describing what you see</div>
                <div><strong>Auto Tagging:</strong> Generates relevant tags automatically</div>
            </div>
        </div>
    </div>

    <!-- Search Modal -->
    <div class="search-modal" id="searchModal">
        <div class="search-box">
            <h2>üß† AI-Powered Image Search</h2>
            <input type="text" class="search-input" id="searchInput" placeholder="Describe what you're looking for... (e.g., 'person wearing red', 'sunset over water', 'dog playing')">
            
            <div class="search-suggestions">
                <div class="search-suggestion" data-query="person smiling">person smiling</div>
                <div class="search-suggestion" data-query="outdoor scene">outdoor scene</div>
                <div class="search-suggestion" data-query="food and drinks">food and drinks</div>
                <div class="search-suggestion" data-query="vehicle or transportation">vehicles</div>
                <div class="search-suggestion" data-query="animals or pets">animals</div>
                <div class="search-suggestion" data-query="architecture or buildings">buildings</div>
            </div>
            
            <div class="search-results" id="searchResults"></div>
            <button class="primary-btn" onclick="closeSearch()" style="margin-top: 20px;">Close</button>
        </div>
    </div>

    <!-- Load TensorFlow.js and Models -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>

    <script>
        let images = [];
        let mobilenetModel = null;
        let objectDetectionModel = null;
        let isModelsLoaded = false;

        const gallery = document.getElementById('gallery');
        const filesInput = document.getElementById('filesInput');
        const folderInput = document.getElementById('folderInput');
        const selectFilesBtn = document.getElementById('selectFiles');
        const selectFolderBtn = document.getElementById('selectFolder');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const searchBtn = document.getElementById('searchBtn');
        const autoTagBtn = document.getElementById('autoTagBtn');
        const exportBtn = document.getElementById('exportBtn');
        const importBtn = document.getElementById('importBtn');
        const importFileInput = document.getElementById('importFileInput');
        const gridLayoutSelect = document.getElementById('gridLayout');
        const imageCountSpan = document.getElementById('imageCount');
        const dropZone = document.getElementById('dropZone');
        const aiStatus = document.getElementById('aiStatus');
        const aiStatusText = document.getElementById('aiStatusText');
        const aiProgressBar = document.getElementById('aiProgressBar');
        const searchModal = document.getElementById('searchModal');
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');

        // Event Listeners
        selectFilesBtn.addEventListener('click', () => filesInput.click());
        selectFolderBtn.addEventListener('click', () => folderInput.click());
        filesInput.addEventListener('change', handleFilesSelect);
        folderInput.addEventListener('change', handleFolderSelect);
        analyzeBtn.addEventListener('click', analyzeAllImages);
        searchBtn.addEventListener('click', openSearch);
        autoTagBtn.addEventListener('click', autoTagImages);
        exportBtn.addEventListener('click', exportMetadata);
        importBtn.addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', importMetadata);
        gridLayoutSelect.addEventListener('change', updateGridLayout);
        searchInput.addEventListener('input', performSemanticSearch);

        // Search suggestions
        document.querySelectorAll('.search-suggestion').forEach(suggestion => {
            suggestion.addEventListener('click', (e) => {
                searchInput.value = e.target.dataset.query;
                performSemanticSearch();
            });
        });

        // Drag and Drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleDroppedFiles(e.dataTransfer.files);
        });

        // Initialize AI models
        async function initializeAI() {
            try {
                showAIStatus('Loading AI models...', 0);
                
                // Check if TensorFlow.js is loaded
                if (typeof tf === 'undefined') {
                    throw new Error('TensorFlow.js not loaded');
                }
                
                // Load MobileNet for image classification
                aiStatusText.textContent = 'Loading MobileNet classification model...';
                updateProgress(25);
                
                if (typeof mobilenet === 'undefined') {
                    throw new Error('MobileNet not available');
                }
                mobilenetModel = await mobilenet.load();
                
                // Load COCO-SSD for object detection
                aiStatusText.textContent = 'Loading object detection model...';
                updateProgress(75);
                
                if (typeof cocoSsd === 'undefined') {
                    throw new Error('COCO-SSD not available');
                }
                objectDetectionModel = await cocoSsd.load();
                
                updateProgress(100);
                aiStatusText.textContent = '‚úÖ AI models ready! You can now analyze images.';
                
                setTimeout(() => {
                    hideAIStatus();
                    isModelsLoaded = true;
                    updateButtonStates();
                }, 2000);
                
            } catch (error) {
                console.error('Error loading AI models:', error);
                aiStatusText.textContent = `‚ùå Error loading AI models: ${error.message}. Falling back to simple search.`;
                
                // Enable fallback mode
                setTimeout(() => {
                    hideAIStatus();
                    enableFallbackMode();
                }, 3000);
            }
        }

        function enableFallbackMode() {
            // Enable buttons but with limited functionality
            analyzeBtn.disabled = false;
            searchBtn.disabled = false;
            autoTagBtn.disabled = false;
            exportBtn.disabled = false;
            importBtn.disabled = false;
            
            // Update button text to indicate fallback mode
            analyzeBtn.innerHTML = 'üìù Simple Tag';
            searchBtn.innerHTML = 'üîç Text Search';
            autoTagBtn.innerHTML = 'üè∑Ô∏è Basic Tags';
            
            console.log('AI models failed to load. Using fallback text-based search.');
        }

        function showAIStatus(text, progress = 0) {
            aiStatus.classList.add('active');
            aiStatusText.textContent = text;
            updateProgress(progress);
        }

        function hideAIStatus() {
            aiStatus.classList.remove('active');
        }

        function updateProgress(percent) {
            aiProgressBar.style.width = percent + '%';
            aiProgressBar.textContent = Math.round(percent) + '%';
        }

        function updateButtonStates() {
            analyzeBtn.disabled = images.length === 0;
            searchBtn.disabled = images.length === 0;
            autoTagBtn.disabled = images.length === 0;
            exportBtn.disabled = images.length === 0;
            importBtn.disabled = false; // Always enabled
        }

        // File handling
        function handleFilesSelect(event) {
            const files = Array.from(event.target.files);
            loadImages(files);
        }

        function handleFolderSelect(event) {
            const files = Array.from(event.target.files);
            loadImages(files);
        }

        function handleDroppedFiles(fileList) {
            const files = Array.from(fileList);
            loadImages(files);
        }

        function loadImages(files) {
            const imageFiles = files.filter(file => 
                /\.(jpg|jpeg|png|gif|webp|bmp)$/i.test(file.name)
            );

            images = imageFiles.map(file => ({
                file: file,
                name: file.name,
                size: file.size,
                date: file.lastModified || Date.now(),
                url: URL.createObjectURL(file),
                caption: file.name.replace(/\.[^/.]+$/, ""),
                aiAnalysis: null,
                objects: [],
                tags: [],
                description: ''
            }));

            renderGallery();
            updateImageCount();
            updateButtonStates();
            
            if (images.length > 0) {
                dropZone.style.display = 'none';
            }
        }

        // AI Analysis Functions
        async function analyzeAllImages() {
            if (images.length === 0) return;

            showAIStatus('Analyzing images...', 0);
            analyzeBtn.innerHTML = '<span class="loading-spinner"></span> Analyzing...';
            analyzeBtn.disabled = true;

            for (let i = 0; i < images.length; i++) {
                const image = images[i];
                const progress = ((i + 1) / images.length) * 100;
                
                aiStatusText.textContent = `Processing image ${i + 1} of ${images.length}: ${image.name}`;
                updateProgress(progress);

                if (isModelsLoaded && mobilenetModel && objectDetectionModel) {
                    await analyzeImageWithAI(image, i);
                } else {
                    // Fallback: simple text-based analysis
                    analyzeImageFallback(image, i);
                }
                renderImageCard(i); // Update the specific card
            }

            analyzeBtn.innerHTML = isModelsLoaded ? 'üß† AI Analyze' : 'üìù Simple Tag';
            analyzeBtn.disabled = false;
            aiStatusText.textContent = `‚úÖ Analysis complete! ${images.length} images processed.`;
            
            setTimeout(hideAIStatus, 3000);
        }

        async function analyzeImageWithAI(image, index) {
            try {
                // Create image element for analysis
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                return new Promise((resolve) => {
                    img.onload = async () => {
                        try {
                            // Object detection
                            const objects = await objectDetectionModel.detect(img);
                            
                            // Image classification
                            const classifications = await mobilenetModel.classify(img);
                            
                            // Process results
                            image.objects = objects.map(obj => ({
                                class: obj.class,
                                confidence: obj.score,
                                bbox: obj.bbox
                            }));

                            image.tags = classifications.slice(0, 5).map(c => ({
                                label: c.className,
                                confidence: c.probability
                            }));

                            // Generate description
                            image.description = generateDescription(image.objects, image.tags);
                            image.aiAnalysis = new Date().toISOString();
                            
                        } catch (error) {
                            console.error('Error analyzing image:', error);
                            // Fallback if AI analysis fails
                            analyzeImageFallback(image, index);
                        }
                        resolve();
                    };
                    
                    img.onerror = () => {
                        console.error('Error loading image for analysis');
                        analyzeImageFallback(image, index);
                        resolve();
                    };
                    
                    img.src = image.url;
                });
                
            } catch (error) {
                console.error('Error in analyzeImageWithAI:', error);
                analyzeImageFallback(image, index);
            }
        }

        function analyzeImageFallback(image, index) {
            // Simple fallback analysis based on filename and basic patterns
            const filename = image.name.toLowerCase();
            const tags = [];
            const objects = [];
            
            // Basic keyword detection
            if (filename.includes('photo') || filename.includes('img') || filename.includes('pic')) {
                tags.push({ label: 'photograph', confidence: 0.8 });
            }
            
            if (filename.includes('selfie') || filename.includes('portrait')) {
                tags.push({ label: 'portrait', confidence: 0.7 });
                objects.push({ class: 'person', confidence: 0.6 });
            }
            
            if (filename.includes('landscape') || filename.includes('nature')) {
                tags.push({ label: 'landscape', confidence: 0.7 });
            }
            
            if (filename.includes('food') || filename.includes('meal') || filename.includes('dinner')) {
                tags.push({ label: 'food', confidence: 0.7 });
            }
            
            if (filename.includes('car') || filename.includes('vehicle')) {
                objects.push({ class: 'car', confidence: 0.6 });
            }
            
            if (filename.includes('dog') || filename.includes('cat') || filename.includes('pet')) {
                objects.push({ class: filename.includes('dog') ? 'dog' : 'cat', confidence: 0.6 });
            }
            
            // Default tags if none found
            if (tags.length === 0) {
                tags.push({ label: 'image', confidence: 0.5 });
            }
            
            image.tags = tags;
            image.objects = objects;
            image.description = `Basic analysis: ${tags.map(t => t.label).join(', ')}`;
            image.aiAnalysis = new Date().toISOString();
        }

        function generateDescription(objects, tags) {
            const descriptions = [];
            
            if (objects.length > 0) {
                const mainObjects = objects
                    .filter(obj => obj.confidence > 0.5)
                    .map(obj => obj.class)
                    .slice(0, 3);
                
                if (mainObjects.length > 0) {
                    descriptions.push(`Contains: ${mainObjects.join(', ')}`);
                }
            }
            
            if (tags.length > 0) {
                const mainTag = tags[0].label.split(',')[0];
                descriptions.push(`Scene: ${mainTag}`);
            }
            
            return descriptions.join(' | ') || 'AI analysis complete';
        }

        async function autoTagImages() {
            if (images.length === 0) return;

            autoTagBtn.innerHTML = '<span class="loading-spinner"></span> Tagging...';
            autoTagBtn.disabled = true;

            // Auto-tag images that haven't been analyzed yet
            for (let i = 0; i < images.length; i++) {
                if (!images[i].aiAnalysis) {
                    if (isModelsLoaded && mobilenetModel && objectDetectionModel) {
                        await analyzeImageWithAI(images[i], i);
                    } else {
                        analyzeImageFallback(images[i], i);
                    }
                }
            }

            renderGallery();
            autoTagBtn.innerHTML = isModelsLoaded ? 'üè∑Ô∏è Auto Tag' : 'üè∑Ô∏è Basic Tags';
            autoTagBtn.disabled = false;
        }

        // Metadata Export/Import Functions
        function exportMetadata() {
            if (images.length === 0) {
                alert('No images to export metadata for');
                return;
            }

            const metadata = createMetadataObject();
            const json = JSON.stringify(metadata, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ai-image-mobilenet-metadata.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`Exported AI metadata for ${images.length} images!\n\nThis file contains:\n‚Ä¢ Image captions\n‚Ä¢ AI-generated tags\n‚Ä¢ Object detection results\n‚Ä¢ Analysis timestamps`);
        }

        function createMetadataObject() {
            const metadata = {
                version: '2.0',
                timestamp: new Date().toISOString(),
                appName: 'AI Image - MobileNet',
                totalImages: images.length,
                aiEnabled: isModelsLoaded,
                captions: {},
                aiData: {}
            };

            // Save captions and AI analysis data
            images.forEach((image, index) => {
                metadata.captions[image.name] = image.caption;
                
                if (image.aiAnalysis) {
                    metadata.aiData[image.name] = {
                        tags: image.tags || [],
                        objects: image.objects || [],
                        description: image.description || '',
                        analysisDate: image.aiAnalysis
                    };
                }
            });

            return metadata;
        }

        function importMetadata(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const metadata = JSON.parse(e.target.result);
                    let loadedCount = 0;
                    
                    // Load captions
                    if (metadata.captions) {
                        images.forEach((image, index) => {
                            if (metadata.captions[image.name]) {
                                image.caption = metadata.captions[image.name];
                                loadedCount++;
                            }
                        });
                    }
                    
                    // Load AI analysis data
                    if (metadata.aiData) {
                        images.forEach((image, index) => {
                            const aiData = metadata.aiData[image.name];
                            if (aiData) {
                                image.tags = aiData.tags || [];
                                image.objects = aiData.objects || [];
                                image.description = aiData.description || '';
                                image.aiAnalysis = aiData.analysisDate || new Date().toISOString();
                            }
                        });
                    }
                    
                    renderGallery();
                    updateImageCount();
                    
                    const aiDataCount = metadata.aiData ? Object.keys(metadata.aiData).length : 0;
                    alert(`Imported metadata successfully!\n\n‚Ä¢ ${loadedCount} captions loaded\n‚Ä¢ ${aiDataCount} AI analysis results loaded\n‚Ä¢ Metadata version: ${metadata.version || '1.0'}`);
                    
                } catch (error) {
                    alert('Error loading metadata file: ' + error.message);
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
            
            // Reset the file input
            event.target.value = '';
        }

        // Search functionality
        function openSearch() {
            if (images.length === 0) {
                alert('Please load some images first');
                return;
            }

            searchModal.classList.add('active');
            searchInput.focus();
        }

        function closeSearch() {
            searchModal.classList.remove('active');
        }

        function performSemanticSearch() {
            const query = searchInput.value.toLowerCase().trim();
            if (!query) {
                searchResults.innerHTML = '';
                return;
            }

            const results = [];
            
            images.forEach((image, index) => {
                let score = 0;
                const queryWords = query.split(' ');
                
                // Search in AI-generated tags
                if (image.tags) {
                    image.tags.forEach(tag => {
                        queryWords.forEach(word => {
                            if (tag.label.toLowerCase().includes(word)) {
                                score += tag.confidence * 3; // Higher weight for AI tags
                            }
                        });
                    });
                }
                
                // Search in detected objects
                if (image.objects) {
                    image.objects.forEach(obj => {
                        queryWords.forEach(word => {
                            if (obj.class.toLowerCase().includes(word)) {
                                score += obj.confidence * 4; // Highest weight for detected objects
                            }
                        });
                    });
                }
                
                // Search in description
                if (image.description) {
                    queryWords.forEach(word => {
                        if (image.description.toLowerCase().includes(word)) {
                            score += 1;
                        }
                    });
                }
                
                // Search in filename and caption
                queryWords.forEach(word => {
                    if (image.name.toLowerCase().includes(word)) score += 0.5;
                    if (image.caption.toLowerCase().includes(word)) score += 0.5;
                });
                
                if (score > 0) {
                    results.push({ index, score, image });
                }
            });

            // Sort by relevance
            results.sort((a, b) => b.score - a.score);

            // Display results
            displaySearchResults(results);
        }

        function displaySearchResults(results) {
            searchResults.innerHTML = '';
            
            if (results.length === 0) {
                searchResults.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No matching images found. Try different keywords or analyze your images first.</p>';
                return;
            }

            results.slice(0, 20).forEach(result => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                
                const tags = result.image.tags ? 
                    result.image.tags.slice(0, 3).map(t => t.label.split(',')[0]).join(', ') : 
                    'Not analyzed';
                
                const objects = result.image.objects ? 
                    result.image.objects.slice(0, 3).map(o => o.class).join(', ') : 
                    'None detected';
                
                item.innerHTML = `
                    <img src="${result.image.url}" class="search-result-thumb">
                    <div class="search-result-info">
                        <strong>${result.image.caption}</strong><br>
                        <small style="color: #666;">AI Tags: ${tags}</small><br>
                        <small style="color: #666;">Objects: ${objects}</small><br>
                        <small style="color: #888;">${result.image.description || 'No description'}</small>
                    </div>
                    <div class="search-result-score">${Math.round(result.score * 100)}%</div>
                `;
                
                item.addEventListener('click', () => {
                    closeSearch();
                    scrollToImage(result.index);
                });
                
                searchResults.appendChild(item);
            });
        }

        function scrollToImage(index) {
            const cards = document.querySelectorAll('.image-card');
            if (cards[index]) {
                cards[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
                cards[index].style.animation = 'pulse 1s';
            }
        }

        // Rendering functions
        function renderGallery() {
            gallery.innerHTML = '';
            images.forEach((image, index) => {
                renderImageCard(index);
            });
        }

        function renderImageCard(index) {
            const image = images[index];
            
            // Remove existing card if it exists
            const existingCard = document.querySelector(`[data-image-index="${index}"]`);
            if (existingCard) {
                existingCard.remove();
            }
            
            const card = document.createElement('div');
            card.className = 'image-card';
            card.setAttribute('data-image-index', index);
            
            if (image.aiAnalysis) {
                card.classList.add('ai-analyzed');
            }
            
            const imageContainer = document.createElement('div');
            imageContainer.className = 'image-container';
            
            const img = document.createElement('img');
            img.src = image.url;
            img.alt = image.name;
            img.loading = 'lazy';
            img.addEventListener('click', () => openImageModal(image.url));
            
            imageContainer.appendChild(img);
            card.appendChild(imageContainer);
            
            const info = document.createElement('div');
            info.className = 'image-info';
            
            // AI Tags
            if (image.tags && image.tags.length > 0) {
                const tagsContainer = document.createElement('div');
                tagsContainer.className = 'ai-tags';
                
                image.tags.slice(0, 4).forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'ai-tag';
                    tagElement.textContent = tag.label.split(',')[0];
                    tagElement.title = `Confidence: ${Math.round(tag.confidence * 100)}%`;
                    tagsContainer.appendChild(tagElement);
                });
                
                info.appendChild(tagsContainer);
            }
            
            // AI Description
            if (image.description) {
                const description = document.createElement('div');
                description.className = 'ai-description';
                description.textContent = image.description;
                info.appendChild(description);
            }
            
            // Caption (editable)
            const caption = document.createElement('div');
            caption.className = 'image-caption';
            caption.contentEditable = true;
            caption.textContent = image.caption;
            caption.addEventListener('blur', () => {
                images[index].caption = caption.textContent;
            });
            caption.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    caption.blur();
                }
            });
            
            info.appendChild(caption);
            
            // Objects detected
            if (image.objects && image.objects.length > 0) {
                const objectsDiv = document.createElement('div');
                objectsDiv.style.fontSize = '11px';
                objectsDiv.style.color = '#888';
                objectsDiv.style.marginTop = '4px';
                
                const detectedObjects = image.objects
                    .filter(obj => obj.confidence > 0.5)
                    .map(obj => `${obj.class} (${Math.round(obj.confidence * 100)}%)`)
                    .slice(0, 3)
                    .join(', ');
                
                if (detectedObjects) {
                    objectsDiv.innerHTML = `üîç Detected: ${detectedObjects}`;
                    info.appendChild(objectsDiv);
                }
            }
            
            card.appendChild(info);
            gallery.appendChild(card);
        }

        function openImageModal(imageUrl) {
            // Simple modal implementation
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
                cursor: pointer;
            `;
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
            `;
            
            modal.appendChild(img);
            document.body.appendChild(modal);
            
            modal.addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        }

        function updateGridLayout() {
            const columns = gridLayoutSelect.value;
            gallery.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;
        }

        function updateImageCount() {
            const analyzedCount = images.filter(img => img.aiAnalysis).length;
            imageCountSpan.textContent = `${images.length} images loaded (${analyzedCount} AI analyzed)`;
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && searchModal.classList.contains('active')) {
                closeSearch();
            }
        });

        // Click outside to close search modal
        searchModal.addEventListener('click', (e) => {
            if (e.target === searchModal) {
                closeSearch();
            }
        });

        // Initialize the app
        updateGridLayout();
        updateButtonStates();
        
        // Start loading AI models immediately
        initializeAI();

        // Welcome message
        console.log(`
üß† AI-Powered Image Viewer
==========================

üöÄ FEATURES:
‚Ä¢ Real computer vision with TensorFlow.js
‚Ä¢ Object detection using COCO-SSD model
‚Ä¢ Image classification with MobileNet
‚Ä¢ Semantic search by visual content
‚Ä¢ Automatic tagging and description generation

üîç SEARCH EXAMPLES:
‚Ä¢ "person" - finds images with people
‚Ä¢ "outdoor" - finds outdoor scenes
‚Ä¢ "food" - finds food-related images
‚Ä¢ "vehicle" - finds cars, bikes, etc.

üí° TIP: Click "AI Analyze" to process all images for best search results!
        `);
    </script>
</body>
</html>